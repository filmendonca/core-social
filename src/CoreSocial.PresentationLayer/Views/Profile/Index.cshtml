@using System.Security.Claims;
@using Utils.Constants;

@model ProfileGetVM

@{
    ViewData["Title"] = "Profile of " + Model.UserName;
}

<div class="container bootstrap snippets bootdeys">
    <div class="row" id="user-profile">
        <div class="col-lg-3 col-md-4 col-sm-4">
            <div class="main-box clearfix">
                <h2>@Model.UserName</h2>
                @*<div class="profile-status">
                    <i class="fa fa-check-circle"></i> Online
                </div>*@
                <img src="~/@Model.AvatarUrl" alt="Image of @Model.UserName"
                     class="profile-img img-responsive center-block" style="max-width: 100%;">
                <div class="profile-label">
                    @switch (Model.Role)
                    {
                        case UserRoles.Admin:
                            <span class="badge rounded-pill bg-danger text-white" style="font-size:15px">@Model.Role</span>
                            break;
                        case UserRoles.Moderator:
                            <span class="badge rounded-pill bg-primary text-white" style="font-size:15px">@Model.Role</span>
                            break;
                        case UserRoles.User:
                            <span class="badge rounded-pill bg-secondary text-white" style="font-size:15px">@Model.Role</span>
                            break;
                    }
                </div>

                <div class="profile-stars">
                    <span>Reputation: @Model.Reputation</span>
                </div>

                <div class="profile-since">
                    Member since: @Model.DateCreated.ToString("MMM yyyy")
                </div>

                <div class="profile-details">
                    <ul class="fa-ul">
                        <li><i class="fa-li fa fa-pencil-square"></i>Posts: <span>@Model.NumPosts</span></li>
                        <li><i class="fa-li fa fa-comment"></i>Comments: <span>@Model.NumComments</span></li>
                    </ul>
                </div>

                <div class="profile-message-btn center-block text-center">

                    @if (Model.Friendship != null)
                    {
                        if (Model.Friendship.IsFriend)
                        {
                            <form method="post" asp-action="RemoveFriend" asp-route-username="@Model.UserName">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="userId" value="@Model.UserId" />
                                <button class="btn btn-danger" type="submit">Remove Friend</button>
                            </form>
                        }
                        else if (Model.Friendship.IsOutgoingRequest)
                        {
                            <span class="text-muted">Friend request sent</span>
                        }
                        else
                        {
                            <form method="post" asp-action="SendRequest" asp-route-username="@Model.UserName">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="recipientId" value="@Model.UserId" />
                                <button class="btn btn-primary" type="submit">Add Friend</button>
                            </form>
                        }
                    }

                </div>

            </div>
        </div>

        <div class="col-lg-9 col-md-8 col-sm-8">
            <div class="main-box clearfix">
                <div class="profile-header">
                    <h3><span>User info</span></h3>
                    @if (Model.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier))
                    {
                        <a asp-action="Edit" class="btn btn-primary edit-profile">
                            <i class="fa fa-pencil-square fa-lg"></i> Edit profile
                        </a>
                    }
                </div>

                <div class="row profile-user-info">
                    <div class="col-sm-8">

                        @if (Model.BirthDate != null)
                        {
                            <div class="profile-user-details clearfix">
                                <div class="profile-user-details-label">
                                    Date of Birth
                                </div>
                                <div class="profile-user-details-value">
                                    @Model.BirthDate?.ToString("dd MMM yyyy")
                                </div>
                            </div>
                        }

                        <div class="profile-user-details clearfix">
                            <div class="profile-user-details-label">
                                Gender
                            </div>
                            <div class="profile-user-details-value">
                                @Model.Gender
                            </div>
                        </div>

                        <div class="profile-user-details clearfix">
                            <div class="profile-user-details-label">
                                Email
                            </div>
                            <div class="profile-user-details-value">
                                @Model.Email
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(Model.PhoneNumber))
                        {
                            <div class="profile-user-details clearfix">
                                <div class="profile-user-details-label">
                                    Phone number
                                </div>
                                <div class="profile-user-details-value">
                                    @Model.PhoneNumber
                                </div>
                            </div>
                        }

                        <div class="profile-user-details clearfix">
                            <div class="profile-user-details-label">
                                Bio
                            </div>
                            <div class="profile-user-details-value">
                                @Model.Bio
                            </div>
                        </div>

                    </div>
                </div>

                @if (Model.IncomingRequests.Any())
                {
                    <h4 class="mt-4">Friend requests</h4>

                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model.IncomingRequests)
                            {
                                <tr>
                                    <td>
                                        <a asp-controller="Profile" asp-action="Other" asp-route-username="@request.RequesterUsername"
                                           class="text-info fw-semibold">
                                            @request.RequesterUsername
                                        </a>
                                    </td>

                                    <td class="text-end">
                                        <div class="d-inline-flex gap-1">
                                            <form method="post" asp-action="AcceptRequest" asp-route-username="@Model.UserName">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="friendshipId" value="@request.FriendshipId" />
                                                <button class="btn btn-success btn-sm">
                                                    Accept
                                                </button>
                                            </form>

                                            <form method="post" asp-action="DeclineRequest" asp-route-username="@Model.UserName">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="friendshipId" value="@request.FriendshipId" />
                                                <button class="btn btn-secondary btn-sm">
                                                    Decline
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    if (Model.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier))
                    {
                        <p class="text-muted mt-3">You have no pending friend requests.</p>
                    }
                }

                <div class="tabs-wrapper profile-tabs">
                    <h4 class="active" data-toggle="tab">Friends</h4>
                    <hr />
                    <div class="tab-content">

                        <ul class="widget-users row">

                            @if (Model.Friends.Any())
                            {
                                @foreach (var friend in Model.Friends)
                                {
                                    <li class="col-md-6 d-flex align-items-center">
                                        <div class="img me-3">
                                            <img src="~/@friend.AvatarUrl" class="img-responsive" alt="Avatar of @friend.UserName">
                                        </div>
                                        <div class="details" style="margin-left:5%">
                                            <div class="name">
                                                <a class="text-primary" asp-action="Other" asp-route-username="@friend.UserName">@friend.UserName</a>
                                            </div>
                                        </div>
                                    </li>
                                }
                            }
                            else
                            {
                                if (Model.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier))
                                {
                                    <p class="mt-3">Currently, you have no friends.</p>
                                }
                                else
                                {
                                    <p class="mt-3">Currently, this user has no friends.</p>
                                }
                            }

                        </ul>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>