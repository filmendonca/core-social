@using PresentationLayer.ViewModels;
@using System.Security.Claims;
@using DataLayer.Enums;
@using Utils.Constants;

@model PostShowVM

@{
    ViewData["Title"] = Model.Title;
}

<div class="container mt-5">

    <a asp-action="Index">Go back to Posts</a>

    <div class="post">
        <div class="post-title">@Model.Title</div>

        @if (Model.UserId != User.FindFirstValue(ClaimTypes.NameIdentifier))
        {
            <div class="post-meta">
                Posted by <a asp-controller="Profile" asp-action="Other" asp-route-username="@Model.Username"
                             class="text-primary">@Model.Username</a> on @Model.DateCreated
                        </div>
        }
        else
        {
            <div class="post-meta">
                Posted by <a asp-controller="Profile" asp-action="Index"
                                class="text-primary">You</a> on @Model.DateCreated
            </div>
        }

        @if (Model.IsEdited)
        {
            <div class="post-meta">Last edited on @Model.DateUpdated</div>
        }

        <hr />

        <div class="post-content">
            <p>@Model.Content</p>
            <div style="text-align:center;">
                <img src="~/@Model.ImageUrl" class="card-img" style="max-width:100%" alt="Image of @Model.Title" />
            </div>
        </div>
        <div class="interaction-buttons">
            <button class="btn btn-primary btn-sm">Upvote</button>
            <button class="btn btn-danger btn-sm">Downvote</button>
            <button class="btn btn-info btn-sm">Comment</button>
            <button class="btn btn-success btn-sm">Share</button>
            <p>@Model.Topic</p>
        </div>
        <hr>

        @if ((User.Identity.IsAuthenticated && Model.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier))
           || (User.IsInRole(UserRoles.Admin) || User.IsInRole(UserRoles.Moderator)))
        {
            <p class="text-lg-center"><a asp-action="Edit" asp-route-id="@Model.Id">Edit</a></p>
            <p class="text-lg-center"><a asp-action="Delete" asp-route-id="@Model.Id">Delete</a></p>

            <form asp-action="ChangeVisibility" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" value="@Model.Id" />
                <select asp-for="Visibility"
                        class="form-control"
                        asp-items="Html.GetEnumSelectList<VisibilityType>()">
                </select>
                <button type="submit" class="btn btn-primary btn-sm mt-2">
                    Save
                </button>
            </form>

        }

    </div>
</div>

<!-- Comment Section -->
<div class="col-md-9 p-4">

    @{
        if (Model.Comments.Any())
        {
            foreach (var comment in Model.Comments)
            {
                <div class="card post-card">
                    <div class="card-body">
                        @* Avatar *@
                        <img style="height:auto; max-width:10%" class="img-thumbnail" src="~/@comment.AvatarUrl" alt="Avatar of @comment.User.UserName" />

                        @if (comment.UserId != User.FindFirstValue(ClaimTypes.NameIdentifier))
                        {
                            <h5 class="card-title">
                                <a asp-controller="Profile" asp-action="Other" asp-route-username="@comment.User.UserName"
                                   class="text-info">@comment.User.UserName</a> on @comment.DateCreated
                            </h5>
                        }
                        else
                        {
                            <h5 class="card-title">
                                <a asp-controller="Profile" asp-action="Index"
                                   class="text-info">You</a> on @comment.DateCreated
                            </h5>
                        }

                        @* Show edit date, if any *@
                        @if (comment.IsEdited)
                        {
                            <h6 class="card-title">Last edited on @comment.DateUpdated</h6>
                        }

                        <p class="card-text comment-content">@comment.Content</p>

                        @* Show comment links *@
                        @if (User.Identity.IsAuthenticated)
                        {
                            <div class="comment-actions">

                                <span><b>Score:</b> @comment.Score</span>
                                <span><b>Your reaction:</b> @comment.UserReaction</span>

                                @if (comment.UserId != User.FindFirstValue(ClaimTypes.NameIdentifier))
                                {
                                    <form asp-controller="Comment" asp-action="React" method="post" class="edit-form d-inline">
                                        @Html.AntiForgeryToken()

                                        <input type="hidden" name="CommentId" value="@comment.Id" />
                                        <input type="hidden" name="PostId" value="@comment.PostId" />

                                        <input class="card-link btn btn-link p-0" name="Type" type="submit" value="@ReactionType.Like" />
                                        <input class="card-link btn btn-link p-0" name="Type" type="submit" value="@ReactionType.Dislike" />
                                    </form>
                                }

                                @if (comment.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier))
                                {
                                    <a href="#" class="card-link edit-comment">Edit</a>
                                    <form asp-controller="Comment" asp-action="Delete" asp-route-id="@comment.Id" asp-route-postId="@comment.PostId" method="post" class="edit-form d-inline">
                                        @Html.AntiForgeryToken()
                                        <input class="card-link btn btn-link p-0" type="submit" value="Delete" />
                                    </form>
                                }

                            </div>

                            <!--Hidden edit actions-->
                            <div class="edit-actions d-none">
                                <form asp-controller="Comment" asp-action="Edit" method="post" class="edit-form d-inline">
                                    @Html.AntiForgeryToken()
                                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                                    <input type="hidden" name="Id" value="@comment.Id" />
                                    <input type="hidden" name="PostId" value="@comment.PostId" />
                                    <input type="hidden" name="Content" class="edit-content-input" />

                                    <button type="submit" class="btn btn-sm btn-success">Save</button>
                                    <button type="button" class="btn btn-sm btn-secondary cancel-edit">Cancel</button>
                                </form>
                            </div>
                        }

                    </div>
                </div>
            }
        }
        else
        {
            <p>This post has no comments.</p>
        }
    }


    <!-- Add more posts as needed -->

    @if (User.Identity.IsAuthenticated)
    {
        <form asp-controller="Comment" asp-action="Create" method="post">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <h2>Comment this post</h2>
            <div class="card mb-3">
                <div class="card-body">
                    @*<label asp-for="Comment.TextBoxContent" class="control-label"></label>*@
                    <textarea asp-for="Comment.Content" name="Content" class="form-control" rows="3" placeholder="Write your comment"></textarea>
                    <span asp-validation-for="Comment.Content" class="text-danger"></span>
                    <input type="hidden" name="PostId" value="@Model.Id">
                    <input type="submit" value="Create" class="btn btn-primary mt-2" />
                </div>
            </div>
        </form>
    }
    else
    {
        <p>You have to be logged in order to comment</p>
    }

</div>

<script>
    $(document).on('click', '.edit-comment', function (e) {
        e.preventDefault();

        const cardBody = $(this).closest('.card-body');
        const contentP = cardBody.find('.comment-content');
        const actions = cardBody.find('.comment-actions');
        const editActions = cardBody.find('.edit-actions');

        //Prevent double edit
        if (cardBody.data('editing')) return;
        cardBody.data('editing', true);

        const originalText = contentP.text().trim();
        cardBody.data('original-text', originalText);

        const textarea = $('<textarea>', {
            class: 'form-control comment-textarea',
            rows: 3,
            text: originalText
        });

        contentP.replaceWith(textarea);

        actions.addClass('d-none');
        editActions.removeClass('d-none');
    });

    $(document).on('click', '.cancel-edit', function () {
        const cardBody = $(this).closest('.card-body');
        const textarea = cardBody.find('.comment-textarea');
        const actions = cardBody.find('.comment-actions');
        const editActions = cardBody.find('.edit-actions');

        const originalText = cardBody.data('original-text');

        const paragraph = $('<p>', {
            class: 'card-text comment-content',
            text: originalText
        });

        textarea.replaceWith(paragraph);

        editActions.addClass('d-none');
        actions.removeClass('d-none');

        cardBody.removeData('editing');
    });

    $(document).on('submit', '.edit-form', function () {
        const form = $(this);
        const cardBody = form.closest('.card-body');
        const textarea = cardBody.find('.comment-textarea');

        //Copy textarea value into hidden input for POST
        form.find('.edit-content-input').val(textarea.val());
    });
</script>


